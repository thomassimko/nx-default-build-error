"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createServerFactory = createServerFactory;
exports.displayExperimentsInfoBox = displayExperimentsInfoBox;
exports.runServer = runServer;
var _constants = _interopRequireDefault(require("constants"));
var _debug = _interopRequireDefault(require("debug"));
var _fs = _interopRequireDefault(require("fs"));
var _http = _interopRequireDefault(require("http"));
var _https = _interopRequireDefault(require("https"));
var _lodash = _interopRequireWildcard(require("lodash"));
var _path = _interopRequireDefault(require("path"));
var _index = _interopRequireDefault(require("../api/index"));
var _utils = require("./cli/utils");
var _configPath = _interopRequireDefault(require("./config-path"));
var _constants2 = require("./constants");
var _utils2 = require("./utils");
function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && Object.prototype.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { _defineProperty(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }
const debug = (0, _debug.default)('verdaccio');
const logger = require('./logger');
function displayExperimentsInfoBox(flags) {
  if (!flags) {
    return;
  }
  const experimentList = Object.keys(flags);
  if (experimentList.length >= 1) {
    logger.warn(
    // eslint-disable-next-line max-len
    `experiments are enabled, it is recommended do not use experiments in production comment out this section to disable it`);
    experimentList.forEach(experiment => {
      // eslint-disable-next-line max-len
      logger.info(`support for experiment [${experiment}] ${flags[experiment] ? 'is enabled' : ' is disabled'}`);
    });
  }
}

/**
 * Exposes a server factory to be instantiated programmatically.
 *
    const app = await runServer(); // default configuration
    const app = await runServer('./config/config.yaml');
    const app = await runServer({ configuration });
    app.listen(4000, (event) => {
      // do something
    });
 * @param config
 */
async function runServer(config) {
  let configurationParsed;
  if (config === undefined || typeof config === 'string') {
    const configPathLocation = (0, _configPath.default)(config);
    configurationParsed = (0, _utils2.parseConfigFile)(configPathLocation);
    if (!configurationParsed.self_path) {
      configurationParsed.self_path = _path.default.resolve(configPathLocation);
    }
  } else if (_lodash.default.isObject(config)) {
    configurationParsed = config;
    if (!configurationParsed.self_path) {
      throw new Error('self_path is required, please provide a valid root path for storage');
    }
  } else {
    throw new Error(_constants2.API_ERROR.CONFIG_BAD_FORMAT);
  }
  const addresses = (0, _utils.getListListenAddresses)(undefined, configurationParsed.listen);
  if (addresses.length > 1) {
    process.emitWarning('You have specified multiple listen addresses, using this method only the first will be used');
  }
  const app = await (0, _index.default)(configurationParsed);
  return createServerFactory(configurationParsed, addresses[0], app);
}

/**
 * Return a native HTTP/HTTPS server instance
 * @param config
 * @param addr
 * @param app
 */
function createServerFactory(config, addr, app) {
  let serverFactory;
  if (addr.proto === 'https') {
    debug('https enabled');
    try {
      let httpsOptions = {
        // disable insecure SSLv2 and SSLv3
        secureOptions: _constants.default.SSL_OP_NO_SSLv2 | _constants.default.SSL_OP_NO_SSLv3
      };
      const keyCertConfig = config.https;
      const pfxConfig = config.https;

      // https must either have key and cert or a pfx and (optionally) a passphrase
      if (!(keyCertConfig.key && keyCertConfig.cert || pfxConfig.pfx)) {
        throw Error('bad format https configuration');
      }
      if (pfxConfig.pfx) {
        const {
          pfx,
          passphrase
        } = pfxConfig;
        httpsOptions = (0, _lodash.assign)(httpsOptions, {
          pfx: _fs.default.readFileSync(pfx),
          passphrase: passphrase || ''
        });
      } else {
        const {
          key,
          cert,
          ca
        } = keyCertConfig;
        httpsOptions = (0, _lodash.assign)(httpsOptions, _objectSpread({
          key: _fs.default.readFileSync(key),
          cert: _fs.default.readFileSync(cert)
        }, ca && {
          ca: _fs.default.readFileSync(ca)
        }));
      }
      // TODO: enable http2 as feature
      // if (config.server.http2) <-- check if force http2
      serverFactory = _https.default.createServer(httpsOptions, app);
    } catch (err) {
      throw new Error(`cannot create https server: ${err.message}`);
    }
  } else {
    // http
    debug('http enabled');
    serverFactory = _http.default.createServer(app);
  }
  if (config.server && typeof config.server.keepAliveTimeout !== 'undefined' &&
  // @ts-ignore
  config.server.keepAliveTimeout !== 'null') {
    // library definition for node is not up to date (doesn't contain recent 8.0 changes)
    serverFactory.keepAliveTimeout = config.server.keepAliveTimeout * 1000;
  }
  // FIXE: I could not find the reason of this code.
  unlinkAddressPath(addr);
  return serverFactory;
}
function unlinkAddressPath(addr) {
  if (addr.path && _fs.default.existsSync(addr.path)) {
    _fs.default.unlinkSync(addr.path);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfY29uc3RhbnRzIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfZGVidWciLCJfZnMiLCJfaHR0cCIsIl9odHRwcyIsIl9sb2Rhc2giLCJfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZCIsIl9wYXRoIiwiX2luZGV4IiwiX3V0aWxzIiwiX2NvbmZpZ1BhdGgiLCJfY29uc3RhbnRzMiIsIl91dGlsczIiLCJfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUiLCJlIiwiV2Vha01hcCIsInIiLCJ0IiwiX19lc01vZHVsZSIsImRlZmF1bHQiLCJoYXMiLCJnZXQiLCJuIiwiX19wcm90b19fIiwiYSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwidSIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImkiLCJzZXQiLCJvYmoiLCJvd25LZXlzIiwia2V5cyIsImdldE93blByb3BlcnR5U3ltYm9scyIsIm8iLCJmaWx0ZXIiLCJlbnVtZXJhYmxlIiwicHVzaCIsImFwcGx5IiwiX29iamVjdFNwcmVhZCIsImFyZ3VtZW50cyIsImxlbmd0aCIsImZvckVhY2giLCJfZGVmaW5lUHJvcGVydHkiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzIiwiZGVmaW5lUHJvcGVydGllcyIsImtleSIsInZhbHVlIiwiX3RvUHJvcGVydHlLZXkiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsImFyZyIsIl90b1ByaW1pdGl2ZSIsIlN0cmluZyIsImlucHV0IiwiaGludCIsInByaW0iLCJTeW1ib2wiLCJ0b1ByaW1pdGl2ZSIsInVuZGVmaW5lZCIsInJlcyIsIlR5cGVFcnJvciIsIk51bWJlciIsImRlYnVnIiwiYnVpbGREZWJ1ZyIsImxvZ2dlciIsImRpc3BsYXlFeHBlcmltZW50c0luZm9Cb3giLCJmbGFncyIsImV4cGVyaW1lbnRMaXN0Iiwid2FybiIsImV4cGVyaW1lbnQiLCJpbmZvIiwicnVuU2VydmVyIiwiY29uZmlnIiwiY29uZmlndXJhdGlvblBhcnNlZCIsImNvbmZpZ1BhdGhMb2NhdGlvbiIsImZpbmRDb25maWdGaWxlIiwicGFyc2VDb25maWdGaWxlIiwic2VsZl9wYXRoIiwicGF0aCIsInJlc29sdmUiLCJfIiwiaXNPYmplY3QiLCJFcnJvciIsIkFQSV9FUlJPUiIsIkNPTkZJR19CQURfRk9STUFUIiwiYWRkcmVzc2VzIiwiZ2V0TGlzdExpc3RlbkFkZHJlc3NlcyIsImxpc3RlbiIsInByb2Nlc3MiLCJlbWl0V2FybmluZyIsImFwcCIsImVuZFBvaW50QVBJIiwiY3JlYXRlU2VydmVyRmFjdG9yeSIsImFkZHIiLCJzZXJ2ZXJGYWN0b3J5IiwicHJvdG8iLCJodHRwc09wdGlvbnMiLCJzZWN1cmVPcHRpb25zIiwiY29uc3RhbnRzIiwiU1NMX09QX05PX1NTTHYyIiwiU1NMX09QX05PX1NTTHYzIiwia2V5Q2VydENvbmZpZyIsImh0dHBzIiwicGZ4Q29uZmlnIiwiY2VydCIsInBmeCIsInBhc3NwaHJhc2UiLCJhc3NpZ24iLCJmcyIsInJlYWRGaWxlU3luYyIsImNhIiwiY3JlYXRlU2VydmVyIiwiZXJyIiwibWVzc2FnZSIsImh0dHAiLCJzZXJ2ZXIiLCJrZWVwQWxpdmVUaW1lb3V0IiwidW5saW5rQWRkcmVzc1BhdGgiLCJleGlzdHNTeW5jIiwidW5saW5rU3luYyJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcnVuLXNlcnZlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY29uc3RhbnRzIGZyb20gJ2NvbnN0YW50cyc7XG5pbXBvcnQgYnVpbGREZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgaHR0cHMgZnJvbSAnaHR0cHMnO1xuaW1wb3J0IF8sIHsgYXNzaWduIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgeyBDb25maWcsIEh0dHBzQ29uZktleUNlcnQsIEh0dHBzQ29uZlBmeCB9IGZyb20gJ0B2ZXJkYWNjaW8vdHlwZXMnO1xuXG5pbXBvcnQgZW5kUG9pbnRBUEkgZnJvbSAnLi4vYXBpL2luZGV4JztcbmltcG9ydCB7IGdldExpc3RMaXN0ZW5BZGRyZXNzZXMgfSBmcm9tICcuL2NsaS91dGlscyc7XG5pbXBvcnQgZmluZENvbmZpZ0ZpbGUgZnJvbSAnLi9jb25maWctcGF0aCc7XG5pbXBvcnQgeyBBUElfRVJST1IgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBwYXJzZUNvbmZpZ0ZpbGUgfSBmcm9tICcuL3V0aWxzJztcblxuY29uc3QgZGVidWcgPSBidWlsZERlYnVnKCd2ZXJkYWNjaW8nKTtcblxuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnLi9sb2dnZXInKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGRpc3BsYXlFeHBlcmltZW50c0luZm9Cb3goZmxhZ3MpIHtcbiAgaWYgKCFmbGFncykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGV4cGVyaW1lbnRMaXN0ID0gT2JqZWN0LmtleXMoZmxhZ3MpO1xuICBpZiAoZXhwZXJpbWVudExpc3QubGVuZ3RoID49IDEpIHtcbiAgICBsb2dnZXIud2FybihcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gICAgICBgZXhwZXJpbWVudHMgYXJlIGVuYWJsZWQsIGl0IGlzIHJlY29tbWVuZGVkIGRvIG5vdCB1c2UgZXhwZXJpbWVudHMgaW4gcHJvZHVjdGlvbiBjb21tZW50IG91dCB0aGlzIHNlY3Rpb24gdG8gZGlzYWJsZSBpdGBcbiAgICApO1xuICAgIGV4cGVyaW1lbnRMaXN0LmZvckVhY2goKGV4cGVyaW1lbnQpID0+IHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gICAgICBsb2dnZXIuaW5mbyhcbiAgICAgICAgYHN1cHBvcnQgZm9yIGV4cGVyaW1lbnQgWyR7ZXhwZXJpbWVudH1dICR7XG4gICAgICAgICAgZmxhZ3NbZXhwZXJpbWVudF0gPyAnaXMgZW5hYmxlZCcgOiAnIGlzIGRpc2FibGVkJ1xuICAgICAgICB9YFxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxufVxuXG4vKipcbiAqIEV4cG9zZXMgYSBzZXJ2ZXIgZmFjdG9yeSB0byBiZSBpbnN0YW50aWF0ZWQgcHJvZ3JhbW1hdGljYWxseS5cbiAqXG4gICAgY29uc3QgYXBwID0gYXdhaXQgcnVuU2VydmVyKCk7IC8vIGRlZmF1bHQgY29uZmlndXJhdGlvblxuICAgIGNvbnN0IGFwcCA9IGF3YWl0IHJ1blNlcnZlcignLi9jb25maWcvY29uZmlnLnlhbWwnKTtcbiAgICBjb25zdCBhcHAgPSBhd2FpdCBydW5TZXJ2ZXIoeyBjb25maWd1cmF0aW9uIH0pO1xuICAgIGFwcC5saXN0ZW4oNDAwMCwgKGV2ZW50KSA9PiB7XG4gICAgICAvLyBkbyBzb21ldGhpbmdcbiAgICB9KTtcbiAqIEBwYXJhbSBjb25maWdcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJ1blNlcnZlcihjb25maWc/OiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICBsZXQgY29uZmlndXJhdGlvblBhcnNlZDogUmV0dXJuVHlwZTxhbnk+O1xuICBpZiAoY29uZmlnID09PSB1bmRlZmluZWQgfHwgdHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHtcbiAgICBjb25zdCBjb25maWdQYXRoTG9jYXRpb24gPSBmaW5kQ29uZmlnRmlsZShjb25maWcpO1xuICAgIGNvbmZpZ3VyYXRpb25QYXJzZWQgPSBwYXJzZUNvbmZpZ0ZpbGUoY29uZmlnUGF0aExvY2F0aW9uKTtcbiAgICBpZiAoIWNvbmZpZ3VyYXRpb25QYXJzZWQuc2VsZl9wYXRoKSB7XG4gICAgICBjb25maWd1cmF0aW9uUGFyc2VkLnNlbGZfcGF0aCA9IHBhdGgucmVzb2x2ZShjb25maWdQYXRoTG9jYXRpb24pO1xuICAgIH1cbiAgfSBlbHNlIGlmIChfLmlzT2JqZWN0KGNvbmZpZykpIHtcbiAgICBjb25maWd1cmF0aW9uUGFyc2VkID0gY29uZmlnO1xuICAgIGlmICghY29uZmlndXJhdGlvblBhcnNlZC5zZWxmX3BhdGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc2VsZl9wYXRoIGlzIHJlcXVpcmVkLCBwbGVhc2UgcHJvdmlkZSBhIHZhbGlkIHJvb3QgcGF0aCBmb3Igc3RvcmFnZScpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoQVBJX0VSUk9SLkNPTkZJR19CQURfRk9STUFUKTtcbiAgfVxuXG4gIGNvbnN0IGFkZHJlc3NlcyA9IGdldExpc3RMaXN0ZW5BZGRyZXNzZXModW5kZWZpbmVkLCBjb25maWd1cmF0aW9uUGFyc2VkLmxpc3Rlbik7XG4gIGlmIChhZGRyZXNzZXMubGVuZ3RoID4gMSkge1xuICAgIHByb2Nlc3MuZW1pdFdhcm5pbmcoXG4gICAgICAnWW91IGhhdmUgc3BlY2lmaWVkIG11bHRpcGxlIGxpc3RlbiBhZGRyZXNzZXMsIHVzaW5nIHRoaXMgbWV0aG9kIG9ubHkgdGhlIGZpcnN0IHdpbGwgYmUgdXNlZCdcbiAgICApO1xuICB9XG5cbiAgY29uc3QgYXBwID0gYXdhaXQgZW5kUG9pbnRBUEkoY29uZmlndXJhdGlvblBhcnNlZCk7XG4gIHJldHVybiBjcmVhdGVTZXJ2ZXJGYWN0b3J5KGNvbmZpZ3VyYXRpb25QYXJzZWQsIGFkZHJlc3Nlc1swXSwgYXBwKTtcbn1cblxuLyoqXG4gKiBSZXR1cm4gYSBuYXRpdmUgSFRUUC9IVFRQUyBzZXJ2ZXIgaW5zdGFuY2VcbiAqIEBwYXJhbSBjb25maWdcbiAqIEBwYXJhbSBhZGRyXG4gKiBAcGFyYW0gYXBwXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTZXJ2ZXJGYWN0b3J5KGNvbmZpZzogQ29uZmlnLCBhZGRyLCBhcHApIHtcbiAgbGV0IHNlcnZlckZhY3Rvcnk7XG4gIGlmIChhZGRyLnByb3RvID09PSAnaHR0cHMnKSB7XG4gICAgZGVidWcoJ2h0dHBzIGVuYWJsZWQnKTtcbiAgICB0cnkge1xuICAgICAgbGV0IGh0dHBzT3B0aW9ucyA9IHtcbiAgICAgICAgLy8gZGlzYWJsZSBpbnNlY3VyZSBTU0x2MiBhbmQgU1NMdjNcbiAgICAgICAgc2VjdXJlT3B0aW9uczogY29uc3RhbnRzLlNTTF9PUF9OT19TU0x2MiB8IGNvbnN0YW50cy5TU0xfT1BfTk9fU1NMdjMsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBrZXlDZXJ0Q29uZmlnID0gY29uZmlnLmh0dHBzIGFzIEh0dHBzQ29uZktleUNlcnQ7XG4gICAgICBjb25zdCBwZnhDb25maWcgPSBjb25maWcuaHR0cHMgYXMgSHR0cHNDb25mUGZ4O1xuXG4gICAgICAvLyBodHRwcyBtdXN0IGVpdGhlciBoYXZlIGtleSBhbmQgY2VydCBvciBhIHBmeCBhbmQgKG9wdGlvbmFsbHkpIGEgcGFzc3BocmFzZVxuICAgICAgaWYgKCEoKGtleUNlcnRDb25maWcua2V5ICYmIGtleUNlcnRDb25maWcuY2VydCkgfHwgcGZ4Q29uZmlnLnBmeCkpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoJ2JhZCBmb3JtYXQgaHR0cHMgY29uZmlndXJhdGlvbicpO1xuICAgICAgfVxuXG4gICAgICBpZiAocGZ4Q29uZmlnLnBmeCkge1xuICAgICAgICBjb25zdCB7IHBmeCwgcGFzc3BocmFzZSB9ID0gcGZ4Q29uZmlnO1xuICAgICAgICBodHRwc09wdGlvbnMgPSBhc3NpZ24oaHR0cHNPcHRpb25zLCB7XG4gICAgICAgICAgcGZ4OiBmcy5yZWFkRmlsZVN5bmMocGZ4KSxcbiAgICAgICAgICBwYXNzcGhyYXNlOiBwYXNzcGhyYXNlIHx8ICcnLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHsga2V5LCBjZXJ0LCBjYSB9ID0ga2V5Q2VydENvbmZpZztcbiAgICAgICAgaHR0cHNPcHRpb25zID0gYXNzaWduKGh0dHBzT3B0aW9ucywge1xuICAgICAgICAgIGtleTogZnMucmVhZEZpbGVTeW5jKGtleSksXG4gICAgICAgICAgY2VydDogZnMucmVhZEZpbGVTeW5jKGNlcnQpLFxuICAgICAgICAgIC4uLihjYSAmJiB7XG4gICAgICAgICAgICBjYTogZnMucmVhZEZpbGVTeW5jKGNhKSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICAvLyBUT0RPOiBlbmFibGUgaHR0cDIgYXMgZmVhdHVyZVxuICAgICAgLy8gaWYgKGNvbmZpZy5zZXJ2ZXIuaHR0cDIpIDwtLSBjaGVjayBpZiBmb3JjZSBodHRwMlxuICAgICAgc2VydmVyRmFjdG9yeSA9IGh0dHBzLmNyZWF0ZVNlcnZlcihodHRwc09wdGlvbnMsIGFwcCk7XG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgY2Fubm90IGNyZWF0ZSBodHRwcyBzZXJ2ZXI6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIC8vIGh0dHBcbiAgICBkZWJ1ZygnaHR0cCBlbmFibGVkJyk7XG4gICAgc2VydmVyRmFjdG9yeSA9IGh0dHAuY3JlYXRlU2VydmVyKGFwcCk7XG4gIH1cblxuICBpZiAoXG4gICAgY29uZmlnLnNlcnZlciAmJlxuICAgIHR5cGVvZiBjb25maWcuc2VydmVyLmtlZXBBbGl2ZVRpbWVvdXQgIT09ICd1bmRlZmluZWQnICYmXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbmZpZy5zZXJ2ZXIua2VlcEFsaXZlVGltZW91dCAhPT0gJ251bGwnXG4gICkge1xuICAgIC8vIGxpYnJhcnkgZGVmaW5pdGlvbiBmb3Igbm9kZSBpcyBub3QgdXAgdG8gZGF0ZSAoZG9lc24ndCBjb250YWluIHJlY2VudCA4LjAgY2hhbmdlcylcbiAgICBzZXJ2ZXJGYWN0b3J5LmtlZXBBbGl2ZVRpbWVvdXQgPSBjb25maWcuc2VydmVyLmtlZXBBbGl2ZVRpbWVvdXQgKiAxMDAwO1xuICB9XG4gIC8vIEZJWEU6IEkgY291bGQgbm90IGZpbmQgdGhlIHJlYXNvbiBvZiB0aGlzIGNvZGUuXG4gIHVubGlua0FkZHJlc3NQYXRoKGFkZHIpO1xuXG4gIHJldHVybiBzZXJ2ZXJGYWN0b3J5O1xufVxuXG5mdW5jdGlvbiB1bmxpbmtBZGRyZXNzUGF0aChhZGRyKSB7XG4gIGlmIChhZGRyLnBhdGggJiYgZnMuZXhpc3RzU3luYyhhZGRyLnBhdGgpKSB7XG4gICAgZnMudW5saW5rU3luYyhhZGRyLnBhdGgpO1xuICB9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsSUFBQUEsVUFBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsTUFBQSxHQUFBRixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUUsR0FBQSxHQUFBSCxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUcsS0FBQSxHQUFBSixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUksTUFBQSxHQUFBTCxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUssT0FBQSxHQUFBQyx1QkFBQSxDQUFBTixPQUFBO0FBQ0EsSUFBQU8sS0FBQSxHQUFBUixzQkFBQSxDQUFBQyxPQUFBO0FBSUEsSUFBQVEsTUFBQSxHQUFBVCxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQVMsTUFBQSxHQUFBVCxPQUFBO0FBQ0EsSUFBQVUsV0FBQSxHQUFBWCxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQVcsV0FBQSxHQUFBWCxPQUFBO0FBQ0EsSUFBQVksT0FBQSxHQUFBWixPQUFBO0FBQTBDLFNBQUFhLHlCQUFBQyxDQUFBLDZCQUFBQyxPQUFBLG1CQUFBQyxDQUFBLE9BQUFELE9BQUEsSUFBQUUsQ0FBQSxPQUFBRixPQUFBLFlBQUFGLHdCQUFBLFlBQUFBLENBQUFDLENBQUEsV0FBQUEsQ0FBQSxHQUFBRyxDQUFBLEdBQUFELENBQUEsS0FBQUYsQ0FBQTtBQUFBLFNBQUFSLHdCQUFBUSxDQUFBLEVBQUFFLENBQUEsU0FBQUEsQ0FBQSxJQUFBRixDQUFBLElBQUFBLENBQUEsQ0FBQUksVUFBQSxTQUFBSixDQUFBLGVBQUFBLENBQUEsdUJBQUFBLENBQUEseUJBQUFBLENBQUEsV0FBQUssT0FBQSxFQUFBTCxD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