"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.loadTheme = loadTheme;
var _debug = _interopRequireDefault(require("debug"));
var _express = require("express");
var _lodash = _interopRequireDefault(require("lodash"));
var _middleware = require("@verdaccio/middleware");
var _pluginLoader = _interopRequireDefault(require("../../lib/plugin-loader"));
var _api = _interopRequireDefault(require("./api"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const debug = (0, _debug.default)('verdaccio:web');
function loadTheme(config) {
  if (_lodash.default.isNil(config.theme) === false) {
    debug('loading custom ui theme');
    return _lodash.default.head((0, _pluginLoader.default)(config, config.theme, {}, function (plugin) {
      return plugin.staticPath && plugin.manifest && plugin.manifestFiles;
    }, 'verdaccio-theme'));
  }
}
var _default = (config, auth, storage) => {
  const pluginOptions = loadTheme(config) || require('@verdaccio/ui-theme')();
  // eslint-disable-next-line new-cap
  const router = (0, _express.Router)();
  router.use(auth.webUIJWTmiddleware());
  router.use(_middleware.setSecurityWebHeaders);
  // render web
  // @ts-ignore
  router.use('/', (0, _middleware.renderWebMiddleware)(config, null, pluginOptions));
  // web endpoints, search, packages, etc
  router.use((0, _api.default)(auth, storage, config));
  return router;
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZGVidWciLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9leHByZXNzIiwiX2xvZGFzaCIsIl9taWRkbGV3YXJlIiwiX3BsdWdpbkxvYWRlciIsIl9hcGkiLCJvYmoiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsImRlYnVnIiwiYnVpbGREZWJ1ZyIsImxvYWRUaGVtZSIsImNvbmZpZyIsIl8iLCJpc05pbCIsInRoZW1lIiwiaGVhZCIsImxvYWRQbHVnaW4iLCJwbHVnaW4iLCJzdGF0aWNQYXRoIiwibWFuaWZlc3QiLCJtYW5pZmVzdEZpbGVzIiwiX2RlZmF1bHQiLCJhdXRoIiwic3RvcmFnZSIsInBsdWdpbk9wdGlvbnMiLCJyb3V0ZXIiLCJSb3V0ZXIiLCJ1c2UiLCJ3ZWJVSUpXVG1pZGRsZXdhcmUiLCJzZXRTZWN1cml0eVdlYkhlYWRlcnMiLCJyZW5kZXJXZWJNaWRkbGV3YXJlIiwid2ViRW5kcG9pbnRzQXBpIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvd2ViL2luZGV4LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBidWlsZERlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgcmVuZGVyV2ViTWlkZGxld2FyZSwgc2V0U2VjdXJpdHlXZWJIZWFkZXJzIH0gZnJvbSAnQHZlcmRhY2Npby9taWRkbGV3YXJlJztcblxuaW1wb3J0IGxvYWRQbHVnaW4gZnJvbSAnLi4vLi4vbGliL3BsdWdpbi1sb2FkZXInO1xuaW1wb3J0IHdlYkVuZHBvaW50c0FwaSBmcm9tICcuL2FwaSc7XG5cbmNvbnN0IGRlYnVnID0gYnVpbGREZWJ1ZygndmVyZGFjY2lvOndlYicpO1xuXG5leHBvcnQgZnVuY3Rpb24gbG9hZFRoZW1lKGNvbmZpZykge1xuICBpZiAoXy5pc05pbChjb25maWcudGhlbWUpID09PSBmYWxzZSkge1xuICAgIGRlYnVnKCdsb2FkaW5nIGN1c3RvbSB1aSB0aGVtZScpO1xuICAgIHJldHVybiBfLmhlYWQoXG4gICAgICBsb2FkUGx1Z2luKFxuICAgICAgICBjb25maWcsXG4gICAgICAgIGNvbmZpZy50aGVtZSxcbiAgICAgICAge30sXG4gICAgICAgIGZ1bmN0aW9uIChwbHVnaW4pIHtcbiAgICAgICAgICByZXR1cm4gcGx1Z2luLnN0YXRpY1BhdGggJiYgcGx1Z2luLm1hbmlmZXN0ICYmIHBsdWdpbi5tYW5pZmVzdEZpbGVzO1xuICAgICAgICB9LFxuICAgICAgICAndmVyZGFjY2lvLXRoZW1lJ1xuICAgICAgKVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgKGNvbmZpZywgYXV0aCwgc3RvcmFnZSkgPT4ge1xuICBjb25zdCBwbHVnaW5PcHRpb25zID0gbG9hZFRoZW1lKGNvbmZpZykgfHwgcmVxdWlyZSgnQHZlcmRhY2Npby91aS10aGVtZScpKCk7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuZXctY2FwXG4gIGNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xuICByb3V0ZXIudXNlKGF1dGgud2ViVUlKV1RtaWRkbGV3YXJlKCkpO1xuICByb3V0ZXIudXNlKHNldFNlY3VyaXR5V2ViSGVhZGVycyk7XG4gIC8vIHJlbmRlciB3ZWJcbiAgLy8gQHRzLWlnbm9yZVxuICByb3V0ZXIudXNlKCcvJywgcmVuZGVyV2ViTWlkZGxld2FyZShjb25maWcsIG51bGwsIHBsdWdpbk9wdGlvbnMpKTtcbiAgLy8gd2ViIGVuZHBvaW50cywgc2VhcmNoLCBwYWNrYWdlcywgZXRjXG4gIHJvdXRlci51c2Uod2ViRW5kcG9pbnRzQXBpKGF1dGgsIHN0b3JhZ2UsIGNvbmZpZykpO1xuICByZXR1cm4gcm91dGVyO1xufTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLElBQUFBLE1BQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLFFBQUEsR0FBQUQsT0FBQTtBQUNBLElBQUFFLE9BQUEsR0FBQUgsc0JBQUEsQ0FBQUMsT0FBQTtBQUVBLElBQUFHLFdBQUEsR0FBQUgsT0FBQTtBQUVBLElBQUFJLGFBQUEsR0FBQUwsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFLLElBQUEsR0FBQU4sc0JBQUEsQ0FBQUMsT0FBQTtBQUFvQyxTQUFBRCx1QkFBQU8sR0FBQSxXQUFBQSxHQUFBLElBQUFBLEdBQUEsQ0FBQUMsVUFBQSxHQUFBRCxHQUFBLEtBQUFFLE9BQUEsRUFBQUYsR0FBQTtBQUVwQyxNQUFNRyxLQUFLLEdBQUcsSUFBQUMsY0FBVSxFQUFDLGVBQWUsQ0FBQztBQUVsQyxTQUFTQyxTQUFTQSxDQUFDQyxNQUFNLEVBQUU7RUFDaEMsSUFBSUMsZUFBQyxDQUFDQyxLQUFLLENBQUNGLE1BQU0sQ0FBQ0csS0FBSyxDQUFDLEtBQUssS0FBSyxFQUFFO0lBQ25DTixLQUFLLENBQUMseUJBQXlCLENBQUM7SUFDaEMsT0FBT0ksZUFBQyxDQUFDRyxJQUFJLENBQ1gsSUFBQUMscUJBQVUsRUFDUkwsTUFBTSxFQUNOQSxNQUFNLENBQUNHLEtBQUssRUFDWixDQUFDLENBQUMsRUFDRixVQUFVRyxNQUFNLEVBQUU7TUFDaEIsT0FBT0EsTUFBTSxDQUFDQyxVQUFVLElBQUlELE1BQU0sQ0FBQ0UsUUFBUSxJQUFJRixNQUFNLENBQUNHLGFBQWE7SUFDckUsQ0FBQyxFQUNELGlCQUNGLENBQ0YsQ0FBQztFQUNIO0FBQ0Y7QUFBQyxJQUFBQyxRQUFBLEdBRWNBLENBQUNWLE1BQU0sRUFBRVcsSUFBSSxFQUFFQyxPQUFPLEtBQUs7RUFDeEMsTUFBTUMsYUFBYSxHQUFHZCxTQUFTLENBQUNDLE1BQU0sQ0FBQyxJQUFJWixPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDO0VBQzNFO0VBQ0EsTUFBTTBCLE1BQU0sR0FBRyxJQUFBQyxlQUFNLEVBQUMsQ0FBQztFQUN2QkQsTUFBTSxDQUFDRSxHQUFHLENBQUNMLElBQUksQ0FBQ00sa0JBQWtCLENBQUMsQ0FBQyxDQUFDO0VBQ3JDSCxNQUFNLENBQUNFLEdBQUcsQ0FBQ0UsaUNBQXFCLENBQUM7RUFDakM7RUFDQTtFQUNBSixNQUFNLENBQUNFLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBQUcsK0JBQW1CLEVBQUNuQixNQUFNLEVBQUUsSUFBSSxFQUFFYSxhQUFhLENBQUMsQ0FBQztFQUNqRTtFQUNBQyxNQUFNLENBQUNFLEdBQUcsQ0FBQyxJQUFBSSxZQUFlLEVBQUNULElBQUksRUFBRUMsT0FBTyxFQUFFWixNQUFNLENBQUMsQ0FBQztFQUNsRCxPQUFPYyxNQUFNO0FBQ2YsQ0FBQztBQUFBTyxPQUFBLENBQUF6QixPQUFBLEdBQUFjLFFBQUEifQ==